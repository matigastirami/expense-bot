# AWS Lightsail Deployment Guide

This guide walks you through deploying the Expense Tracker Telegram Bot to AWS Lightsail using Terraform and GitHub Actions.

## üèóÔ∏è Architecture Overview

- **Infrastructure**: AWS Lightsail instance ($3.50/month)
- **Database**: Supabase (external)
- **Deployment**: GitHub Actions
- **Infrastructure as Code**: Terraform
- **Containerization**: Docker

## üìã Prerequisites

Before starting, ensure you have:

- [x] AWS Account with programmatic access
- [x] GitHub repository with your code
- [x] Supabase database instance
- [x] Telegram Bot Token
- [x] OpenAI API Key
- [x] Terraform installed locally (optional, for local testing)

## üöÄ Step-by-Step Deployment

### 1. Configure AWS Credentials

Create an AWS IAM user with the following permissions:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "lightsail:*"
            ],
            "Resource": "*"
        }
    ]
}
```

### 2. Set up GitHub Secrets

In your GitHub repository, go to **Settings ‚Üí Secrets and variables ‚Üí Actions** and add:

#### Infrastructure Secrets (for Terraform):
- `AWS_ACCESS_KEY_ID` - Your AWS access key
- `AWS_SECRET_ACCESS_KEY` - Your AWS secret key

#### Deployment Secrets (for GitHub Actions):
- `LIGHTSAIL_HOST` - Will be set after Terraform creates the instance
- `LIGHTSAIL_SSH_KEY` - Will be generated by Terraform
- `GITHUB_TOKEN` - Automatically available, no need to set

#### Application Secrets:
- `POSTGRES_HOST` - Your Supabase database host (e.g., `db.xxx.supabase.co`)
- `POSTGRES_PORT` - Usually `5432`
- `POSTGRES_DB` - Usually `postgres`
- `POSTGRES_USER` - Usually `postgres`
- `POSTGRES_PASSWORD` - Your Supabase database password
- `TELEGRAM_BOT_TOKEN` - Your Telegram bot token
- `OPENAI_API_KEY` - Your OpenAI API key

### 3. Deploy Infrastructure with Terraform

#### Option A: Automatic (Recommended)
Push changes to the `terraform/` directory to trigger the Terraform workflow:

```bash
git add terraform/
git commit -m "feat: add terraform infrastructure"
git push origin main
```

The GitHub Actions workflow will:
1. Validate Terraform configuration
2. Create AWS Lightsail infrastructure
3. Output the instance IP and SSH key

#### Option B: Manual Deployment
If you prefer to run Terraform locally:

```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values

terraform init
terraform plan
terraform apply
```

### 4. Configure GitHub Secrets with Terraform Outputs

After Terraform runs, add these secrets to GitHub:

1. **LIGHTSAIL_HOST**: Copy the `static_ip` output from Terraform
2. **LIGHTSAIL_SSH_KEY**: Copy the `private_key` output from Terraform (sensitive)

You can get these values from:
- GitHub Actions logs (Terraform workflow)
- Or locally: `terraform output static_ip` and `terraform output -raw private_key`

### 5. Deploy the Application

Once GitHub secrets are configured, push any code change to trigger deployment:

```bash
git add .
git commit -m "feat: deploy application"
git push origin main
```

The deployment workflow will:
1. Build Docker image
2. Push to GitHub Container Registry
3. SSH to Lightsail instance
4. Deploy the container
5. Perform health checks

## üîß Manual Server Setup (If Needed)

If you need to set up the server manually or the user_data script failed:

```bash
# SSH to your instance
ssh ubuntu@YOUR_INSTANCE_IP -i path/to/private-key.pem

# Run the setup script
curl -fsSL https://raw.githubusercontent.com/YOUR_USERNAME/expense-tracker-claude/main/scripts/setup-server.sh | bash

# Or clone and run locally
git clone https://github.com/YOUR_USERNAME/expense-tracker-claude.git
cd expense-tracker-claude
chmod +x scripts/setup-server.sh
./scripts/setup-server.sh
```

## üñ•Ô∏è Server Management

### Useful Commands

```bash
# SSH to server
ssh ubuntu@YOUR_INSTANCE_IP

# Check service status
sudo systemctl status expense-tracker
docker-compose ps

# View logs
docker-compose logs -f
tail -f /opt/expense-tracker/logs/health-check.log

# Manual deployment
cd /opt/expense-tracker
./scripts/deploy.sh

# Health check
./scripts/health-check.sh
./scripts/health-check.sh --auto-restart

# Restart service
docker-compose restart
sudo systemctl restart expense-tracker
```

### Monitoring

The system includes several monitoring tools:

1. **Health Check Endpoint**: `http://YOUR_IP:8000/health`
2. **Automated Health Monitoring**: Run `./scripts/health-check.sh --auto-restart` in cron
3. **Container Health Checks**: Built into Docker Compose
4. **System Monitoring**: htop, iotop, nethogs installed

### Logs Location

- **Application Logs**: `/opt/expense-tracker/logs/`
- **Docker Logs**: `docker-compose logs`
- **System Logs**: `/var/log/`
- **Health Check Logs**: `/opt/expense-tracker/logs/health-check.log`

## üõ°Ô∏è Security Features

The setup includes several security measures:

- **UFW Firewall**: Only SSH, HTTP, HTTPS, and health check port open
- **fail2ban**: Protects against SSH brute force attacks
- **Non-root Container**: App runs as non-root user
- **Automatic Updates**: System packages kept up to date
- **Log Rotation**: Prevents disk space issues

## üí∞ Cost Breakdown

- **AWS Lightsail nano**: $3.50/month
- **Supabase**: $0 (free tier) or your existing plan
- **GitHub Actions**: 2000 minutes/month free
- **Total**: ~$3.50/month

## üêõ Troubleshooting

### Common Issues

#### 1. Health Check Fails
```bash
# Check container status
docker-compose ps
docker-compose logs

# Check if port is accessible
curl http://localhost:8000/health
telnet localhost 8000
```

#### 2. SSH Connection Issues
```bash
# Check if instance is running
aws lightsail get-instances

# Verify security group rules
aws lightsail get-instance-port-states --instance-name expense-tracker-bot

# Test SSH key
ssh -i path/to/key.pem -o ConnectTimeout=10 ubuntu@YOUR_IP
```

#### 3. Deployment Fails
```bash
# Check GitHub Actions logs
# Verify all secrets are set correctly
# Check container logs on server

# Manual deployment
ssh ubuntu@YOUR_IP
cd /opt/expense-tracker
git pull
./scripts/deploy.sh
```

#### 4. Database Connection Issues
```bash
# Test database connectivity
docker run --rm postgres:15 pg_isready -h YOUR_SUPABASE_HOST -p 5432

# Check environment variables
docker-compose config
```

### Log Analysis

```bash
# Application errors
docker-compose logs app | grep ERROR

# System resource usage
htop
df -h
free -m

# Network connectivity
netstat -tlnp
ss -tlnp
```

## üîÑ Updates and Maintenance

### Automatic Updates
- **Code Changes**: Automatically deployed via GitHub Actions
- **Security Updates**: System packages updated during bootstrap

### Manual Updates
```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Update Docker images
docker-compose pull
docker-compose up -d

# Clean up old images
docker image prune -f
docker system prune -f
```

### Backup Strategy
- **Database**: Managed by Supabase
- **Application Logs**: Rotated automatically
- **Configuration**: Stored in Git repository

## üöÄ Scaling Options

If you need to scale beyond the nano instance:

1. **Vertical Scaling**: Change `bundle_id` in Terraform
   - `micro_2_0`: $5/month (1 vCPU, 1GB RAM)
   - `small_2_0`: $10/month (1 vCPU, 2GB RAM)

2. **Horizontal Scaling**: 
   - Use Lightsail Load Balancer
   - Deploy multiple instances
   - Configure load balancing

3. **Migration to ECS/EKS**: For enterprise needs

## üìû Support

If you encounter issues:

1. Check the troubleshooting section above
2. Review GitHub Actions logs
3. Check server logs via SSH
4. Verify all secrets and environment variables
5. Test individual components (database, bot, health check)

---

## üéâ Success!

Once deployed, your bot will be running 24/7 on AWS Lightsail with:
- ‚úÖ Automatic deployments
- ‚úÖ Health monitoring
- ‚úÖ Security hardening  
- ‚úÖ Log management
- ‚úÖ Zero-downtime updates
- ‚úÖ Cost-effective hosting ($3.50/month)

Your users can now interact with the bot anytime, and you have a production-ready deployment pipeline!