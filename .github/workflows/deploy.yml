name: Deploy to AWS Lightsail

on:
  push:
    branches: [main]
    paths-ignore:
      - "terraform/**"
      - "docs/**"
      - "*.md"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  check-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      infrastructure-ready: ${{ steps.check.outputs.ready }}
    steps:
      - name: Check if infrastructure secrets exist
        id: check
        run: |
          if [[ -n "${{ secrets.LIGHTSAIL_HOST }}" && -n "${{ secrets.LIGHTSAIL_SSH_KEY }}" ]]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Infrastructure secrets are available"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "‚ùå Infrastructure secrets missing. Run Terraform first."
          fi

  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    needs: [build, check-infrastructure]
    runs-on: ubuntu-latest
    if: needs.check-infrastructure.outputs.infrastructure-ready == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIGHTSAIL_SSH_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          echo "  ConnectTimeout 30" >> ~/.ssh/config
          echo "  ServerAliveInterval 60" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Debug SSH Configuration
        env:
          HOST_IP: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          echo "üîç Debugging SSH connection..."
          echo "Host IP: ${HOST_IP}"
          echo "SSH Agent status:"
          ssh-add -l || echo "No SSH keys loaded"
          echo ""
          echo "Testing network connectivity..."
          ping -c 3 ${HOST_IP} || echo "Host unreachable"
          echo ""
          echo "Testing SSH port..."
          nc -zv ${HOST_IP} 22 || echo "SSH port not open"

      - name: Wait for SSH availability
        env:
          HOST_IP: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          echo "üîå Waiting for SSH to become available on ${HOST_IP}..."

          # First check if host is reachable
          if ! ping -c 1 ${HOST_IP} >/dev/null 2>&1; then
            echo "‚ùå Host ${HOST_IP} is not reachable"
            exit 1
          fi

          # Wait for SSH with better error reporting
          for i in {1..40}; do
            echo "   Attempting SSH connection... ($i/40)"
            if ssh -o BatchMode=yes -o ConnectTimeout=10 -o ServerAliveInterval=5 ubuntu@${HOST_IP} "echo 'SSH connection successful'; uptime" 2>/dev/null; then
              echo "‚úÖ SSH connection established successfully"
              break
            fi

            # Check if we're at the last attempt
            if [ $i -eq 40 ]; then
              echo "‚ùå SSH connection failed after 40 attempts (6+ minutes)"
              echo "üîç Final diagnostic attempts..."

              # Try to get more info about the connection failure
              echo "Testing telnet to SSH port:"
              timeout 5 telnet ${HOST_IP} 22 || echo "Telnet to port 22 failed"

              echo "Checking SSH key fingerprint:"
              ssh-keyscan ${HOST_IP} || echo "SSH keyscan failed"

              echo "‚ùå Deployment failed due to SSH connectivity issues"
              echo "üí° Possible solutions:"
              echo "   1. Run the Terraform workflow to ensure infrastructure exists"
              echo "   2. Check if the Lightsail instance is running"
              echo "   3. Verify SSH key and host secrets are correctly set"
              exit 1
            fi

            sleep 10
          done

      - name: Deploy to Lightsail
        env:
          HOST_IP: ${{ secrets.LIGHTSAIL_HOST }}
          DOCKER_IMAGE: ${{ needs.build.outputs.image-tag }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          # Extract first image tag
          IMAGE_TAG=$(echo "${DOCKER_IMAGE}" | head -n1)
          echo "üö¢ Deploying image: ${IMAGE_TAG}"

          # Ensure directory exists
          ssh ubuntu@${HOST_IP} "sudo mkdir -p /opt/expense-tracker && sudo chown ubuntu:ubuntu /opt/expense-tracker"

          # Copy files to server
          echo "üìÅ Copying deployment files..."
          scp docker-compose.prod.yml ubuntu@${HOST_IP}:/opt/expense-tracker/docker-compose.yml
          scp deploy.sh ubuntu@${HOST_IP}:/opt/expense-tracker/deploy.sh

          # Execute deployment
          echo "üöÄ Executing deployment..."
          ssh ubuntu@${HOST_IP} "cd /opt/expense-tracker && chmod +x deploy.sh && \
            DOCKER_IMAGE='${IMAGE_TAG}' \
            POSTGRES_HOST='${POSTGRES_HOST}' \
            POSTGRES_PORT='${POSTGRES_PORT}' \
            POSTGRES_DB='${POSTGRES_DB}' \
            POSTGRES_USER='${POSTGRES_USER}' \
            POSTGRES_PASSWORD='${POSTGRES_PASSWORD}' \
            TELEGRAM_BOT_TOKEN='${TELEGRAM_BOT_TOKEN}' \
            OPENAI_API_KEY='${OPENAI_API_KEY}' \
            GITHUB_TOKEN='${GITHUB_TOKEN}' \
            GITHUB_ACTOR='${GITHUB_ACTOR}' \
            ./deploy.sh"

      - name: Verify deployment
        env:
          HOST_IP: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          # Wait a moment for the service to fully start
          sleep 30

          # Check if the health endpoint responds
          if curl -f http://${HOST_IP}:8000/health; then
            echo "‚úÖ Deployment successful - health check passed"
          else
            echo "‚ùå Deployment failed - health check failed"
            exit 1
          fi

      - name: Notify deployment status
        env:
          HOST_IP: ${{ secrets.LIGHTSAIL_HOST }}
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üöÄ Deployment to Lightsail completed successfully!"
            echo "üîó Health check: http://${HOST_IP}:8000/health"
          else
            echo "üí• Deployment failed!"
          fi

  infrastructure-warning:
    needs: check-infrastructure
    runs-on: ubuntu-latest
    if: needs.check-infrastructure.outputs.infrastructure-ready == 'false'
    steps:
      - name: Infrastructure Warning
        run: |
          echo "‚ö†Ô∏è Cannot deploy: Infrastructure secrets are missing"
          echo ""
          echo "üîß To fix this, run the Terraform workflow first:"
          echo "   1. Go to Actions tab"
          echo "   2. Run 'Terraform Infrastructure' workflow"
          echo "   3. This will create the Lightsail instance and set up secrets"
          echo ""
          echo "Or trigger it by making a change to terraform/ files and pushing"
